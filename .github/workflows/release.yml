name: Release

# Trigger workflow when a tag matching v* pattern is pushed
# Example: git tag v1.0.0 && git push origin v1.0.0
on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Build and Release Docker Image
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for changelog generation

      # Step 2: Set up Docker Buildx for advanced build features
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: Extract version number from git tag
      # If tag is v1.0.0, extracts "1.0.0" and "v1.0.0"
      - name: Extract version from tag
        id: tag
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          echo "Full tag: ${GITHUB_REF#refs/tags/}"

      # Step 4: Generate changelog from git commits
      # This creates release notes automatically from commit messages
      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found. Showing all commits."
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Previous tag: $PREVIOUS_TAG"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges ${PREVIOUS_TAG}..HEAD)
          fi

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- No changes detected"
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Step 5: Check if Docker Hub credentials are configured
      - name: Check Docker Hub credentials
        id: dockerhub
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          if [ -n "$DOCKER_USERNAME" ] && [ -n "$DOCKER_PASSWORD" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
          fi

      # Step 6: Login to Docker Hub (optional - only if secrets are configured)
      - name: Login to Docker Hub
        if: steps.dockerhub.outputs.configured == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Step 7: Login to GitHub Container Registry (ghcr.io)
      # Uses built-in GITHUB_TOKEN - no additional setup needed
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Step 8: Prepare Docker image tags
      # Creates tags for both versioned and latest images
      - name: Prepare tags
        id: tags
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          # Convert repository name to lowercase (Docker requires lowercase)
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_lower=$REPO_LOWER" >> $GITHUB_OUTPUT

          # Always tag for GitHub Container Registry
          TAGS="ghcr.io/$REPO_LOWER:${{ steps.tag.outputs.tag }}"
          TAGS="$TAGS ghcr.io/$REPO_LOWER:latest"

          # Optionally tag for Docker Hub if credentials are provided
          if [ "${{ steps.dockerhub.outputs.configured }}" == "true" ]; then
            TAGS="$TAGS $DOCKER_USERNAME/task-manager:${{ steps.tag.outputs.tag }}"
            TAGS="$TAGS $DOCKER_USERNAME/task-manager:latest"
          fi

          # Output tags in multiline format for docker/build-push-action
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS" | tr ' ' '\n' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "Prepared tags:"
          echo "$TAGS" | tr ' ' '\n'

      # Step 9: Build and push Docker image
      # Uses BuildKit caching for faster builds
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          # Use GitHub Actions cache for Docker layers
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Add metadata labels to the image
          labels: |
            org.opencontainers.image.title=Task Manager Application
            org.opencontainers.image.description=Next.js Task Manager with PostgreSQL
            org.opencontainers.image.version=${{ steps.tag.outputs.tag }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            org.opencontainers.image.source=${{ github.repositoryUrl }}

      # Step 10: Verify image was pushed successfully
      - name: Verify image push
        run: |
          echo "Verifying image: ghcr.io/${{ steps.tags.outputs.repo_lower }}:${{ steps.tag.outputs.tag }}"
          docker pull ghcr.io/${{ steps.tags.outputs.repo_lower }}:${{ steps.tag.outputs.tag }} || exit 1
          echo "‚úÖ Image verified successfully!"

      # Step 11: Prepare release body
      - name: Prepare release body
        id: release-body
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          REPO_LOWER="${{ steps.tags.outputs.repo_lower }}"
          RELEASE_BODY="## üöÄ Release ${{ steps.tag.outputs.tag }}

          ### üì¶ Docker Images

          **GitHub Container Registry:**
          - \`ghcr.io/$REPO_LOWER:${{ steps.tag.outputs.tag }}\`
          - \`ghcr.io/$REPO_LOWER:latest\`"

          if [ "${{ steps.dockerhub.outputs.configured }}" == "true" ]; then
            RELEASE_BODY="$RELEASE_BODY

          **Docker Hub:**
          - \`$DOCKER_USERNAME/task-manager:${{ steps.tag.outputs.tag }}\`
          - \`$DOCKER_USERNAME/task-manager:latest\`"
          fi

          RELEASE_BODY="$RELEASE_BODY

          ### üìù Changes in this Release

          ${{ steps.changelog.outputs.changelog }}

          ### üê≥ Usage

          Pull and run the Docker image:

          \`\`\`bash
          # Pull the image
          docker pull ghcr.io/$REPO_LOWER:${{ steps.tag.outputs.tag }}

          # Run the container
          docker run -p 3000:3000 \\
            -e DATABASE_URL=your_database_url \\
            -e JWT_SECRET=your_jwt_secret \\
            ghcr.io/$REPO_LOWER:${{ steps.tag.outputs.tag }}
          \`\`\`

          Or use with docker-compose (see docker-compose.yml in repository).

          ### üìä Build Information

          - **Commit:** ${{ github.sha }}
          - **Workflow:** ${{ github.workflow }}
          - **Build Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Step 12: Create GitHub Release with release notes
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body: ${{ steps.release-body.outputs.body }}
          draft: false
          prerelease: false
          generate_release_notes: true # Auto-generate release notes from PRs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
